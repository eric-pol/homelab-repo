---
# ansible/site.yml

# ==========================================
# 1. BASELINE: Apply to Every Server
# ==========================================
- name: Apply Common Configuration
  hosts: all
  become: yes
  roles:
    - role: common
      # Configures Users (eric/ansible), SSH, Timezone, Shell

# ==========================================
# 2. TIER 0: Storage Configuration
# ==========================================
# Moved to TrueNAS

# ==========================================
# 3. TIER 1 & 2: Docker Engine Setup
# ==========================================
- name: Install Docker Engine
  hosts: docker_nodes
  become: yes
  roles:
    - role: common  # Run common again to ensure dependencies? Usually not needed if run above.
    - role: geerlingguy.docker  # (Or your own 'docker_host' role)
      vars:
        docker_users: ["eric", "ansible"]

# ==========================================
# 4. TIER 1: Infrastructure Services
# ==========================================
- name: Deploy Core Infrastructure
  hosts: infra
  become: yes

  # 1. ROLES run first (Deploy Containers)
  roles:
    - role: docker_service
      vars:
        service_name: pihole
        service_path: "{{ playbook_dir }}/../docker/infra/pihole"
    
#    - role: docker_service
#      vars:
#        service_name: keycloak
#        service_path: "{{ playbook_dir }}/../docker/infra/keycloak"

  # 2. TASKS run after roles (Configure Firewall)
  tasks:
    - name: Ensure UFW is installed
      ansible.builtin.apt:
        name: ufw
        state: present

    - name: Allow SSH (Absolute Priority - Do not lock out!)
      community.general.ufw:
        rule: allow
        port: '22'
        proto: tcp
        comment: "Management SSH Access"

    - name: Allow DHCP (UDP) - Critical for Pi-hole
      community.general.ufw:
        rule: allow
        proto: udp
        port: '67'
        # Note: We allow from 'any' because devices asking for an IP 
        # have no IP yet (0.0.0.0), so src restriction blocks them.
        comment: "Pi-hole DHCP Server"

    - name: Allow DNS (UDP) from Home Network
      community.general.ufw:
        rule: allow
        proto: udp
        port: '53'
        src: '192.168.178.0/24'
        comment: "Pi-hole DNS Requests"

    - name: Allow DNS (TCP) from Home Network
      community.general.ufw:
        rule: allow
        proto: tcp
        port: '53'
        src: '192.168.178.0/24'
        comment: "Pi-hole DNS Requests"

    - name: Allow Pi-hole Web Interface (Home Network Only)
      community.general.ufw:
        rule: allow
        proto: tcp
        port: '80'
        src: '192.168.178.0/24'
        comment: "Pi-hole Admin Dashboard"

    - name: Enable UFW and set default deny
      community.general.ufw:
        state: enabled
        policy: deny
        direction: incoming        

# ==========================================
# 5. TIER 2: Production Applications
# ==========================================
- name: Deploy Production Apps
  hosts: apps
  become: yes

  pre_tasks:
    # Ensure NFS mounts exist BEFORE starting Docker
# --- SAFE MOUNTS (Added nofail) ---
    - name: Mount NAS Media
      mount:
        path: /mnt/media
        src: 192.168.178.20:/mnt/tank/media
        fstype: nfs
        opts: defaults,nofail,_netdev,bg
        state: mounted

    - name: Mount NAS Data
      mount:
        path: /mnt/data
        src: 192.168.178.20:/mnt/tank/data
        fstype: nfs
        opts: defaults,nofail,_netdev,bg
        state: mounted

    - name: Mount NAS Backups
      mount:
        path: /mnt/backups
        src: 192.168.178.20:/mnt/tank/backups
        fstype: nfs
        opts: defaults,nofail,_netdev,bg
        state: mounted
    
    - name: Ensure Roon Backup Directory Exists on NAS
      file:
        path: /mnt/backups/roon
        state: directory
        mode: '0775'
      become: false  # Run as eric to bypass NFS Root Squash

  roles:
    - role: docker_service
      vars:
        service_name: plex
        service_path: "{{ playbook_dir }}/../docker/apps/plex"
    
    - role: docker_service
      vars:
        service_name: nextcloud
        service_path: "{{ playbook_dir }}/../docker/apps/nextcloud"

    - role: docker_service
      vars:
        service_name: roon
        service_path: "{{ playbook_dir }}/../docker/apps/roon"
