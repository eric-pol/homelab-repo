---
# tasks file for foreman_setup

- name: Update all packages
  dnf:
    name: "*"
    state: latest

- name: Install Foreman and Katello release repos
  dnf:
    name:
      - https://yum.theforeman.org/releases/3.16/el9/x86_64/foreman-release.rpm
      - https://yum.theforeman.org/katello/4.18/katello/el9/x86_64/katello-repos-latest.rpm
    state: present
    disable_gpg_check: yes

- name: Enable Ruby 3.0 module stream (Required for Foreman 3.16)
  shell: |
    dnf module reset ruby -y
    dnf module enable ruby:3.0 -y
  register: ruby_module
  changed_when: "'Complete!' in ruby_module.stdout"

- name: Enable PostgreSQL 15 module stream
  shell: |
    dnf module reset postgresql -y
    dnf module enable postgresql:15 -y
  register: pg_module
  changed_when: "'Complete!' in pg_module.stdout"

- name: Install foreman-installer
  dnf:
    name: foreman-installer-katello
    state: present

# --- THE POSTGRESQL 15 FIX ---
- name: Ensure PostgreSQL is initialized and running
  systemd:
    name: postgresql
    state: started
    enabled: yes

- name: Grant public schema permissions on template1 for PG15 compatibility
  become_user: postgres
  postgresql_privs:
    db: template1
    privs: ALL
    type: schema
    objs: public
    role: public

- name: Ensure pulp user is a Superuser to bypass PG15 locks
  become_user: postgres
  postgresql_user:
    name: pulp
    role_attr_flags: SUPERUSER
  ignore_errors: yes  # User might not exist until installer starts, but good to have
