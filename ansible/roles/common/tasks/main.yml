---
# ansible/roles/common/tasks/main.yml

# 1. Enable EPEL for RHEL-based systems (Required for htop, etc.)
- name: Install EPEL repository (RHEL/CentOS)
  dnf:
    name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm"
    state: present
    disable_gpg_check: true
  when: ansible_facts['os_family'] == "RedHat"

- name: Enable CRB repository (RHEL 9)
  command: dnf config-manager --set-enabled crb
  register: crb_enable
  changed_when: "'enabled' in crb_enable.stdout"
  failed_when: false # <--- This prevents the playbook from stopping if it fails
  when: 
    - ansible_facts['os_family'] == "RedHat"
    - ansible_facts['distribution_major_version'] == "9"

# 2. Basic System Packages
- name: Install standard system utilities (Debian/Ubuntu)
  apt:
    name: [curl, git, htop, net-tools, vim, unattended-upgrades, nfs-common]
    state: present
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_facts['os_family'] == "Debian"

- name: Install standard system utilities (RHEL/CentOS)
  dnf:
    name: [curl, git, htop, net-tools, vim-enhanced, nfs-utils]
    state: present
  when: ansible_facts['os_family'] == "RedHat"

# 3. Define OS-specific group names
- name: Set OS-specific facts
  set_fact:
    admin_group: "{{ 'sudo' if ansible_os_family == 'Debian' else 'wheel' }}"

# 4. User Management: Eric (Interactive User)
- name: Ensure user 'eric' exists
  user:
    name: eric
    shell: /bin/bash
    groups: "{{ admin_group }}"
    append: yes
    password_lock: no

# 5. User Management: Ansible (Automation User)
- name: Ensure user 'ansible' exists
  user:
    name: ansible
    shell: /bin/bash
    groups: "{{ admin_group }}"
    append: yes
    password_lock: yes

# 6. SSH Key Management
- name: Set authorized key for 'ansible' user
  authorized_key:
    user: ansible
    state: present
    key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"

- name: Set authorized key for 'eric' user
  authorized_key:
    user: eric
    state: present
    key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"

# 7. Sudoers Configuration
- name: Remove legacy sudoers file (cleanup)
  file:
    path: /etc/sudoers.d/ansible
    state: absent

- name: Configure passwordless sudo for ansible user
  copy:
    dest: /etc/sudoers.d/z99-ansible
    content: "ansible ALL=(ALL) NOPASSWD: ALL\n"
    owner: root
    group: root
    mode: '0440'
    validate: visudo -cf %s
