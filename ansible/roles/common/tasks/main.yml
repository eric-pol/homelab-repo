---
# ansible/roles/common/tasks/main.yml

# 1. Basic System Packages (OS Aware)
- name: Install standard system utilities (Debian/Ubuntu)
  apt:
    name:
      - curl
      - git
      - htop
      - net-tools
      - vim
      - unattended-upgrades
      - nfs-common
    state: present
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- name: Install standard system utilities (RHEL/CentOS)
  dnf:
    name:
      - curl
      - git
      - htop
      - net-tools
      - vim-enhanced
      - nfs-utils
    state: present
  when: ansible_os_family == "RedHat"

# 2. Define OS-specific group names
- name: Set OS-specific facts
  set_fact:
    admin_group: "{{ 'sudo' if ansible_os_family == 'Debian' else 'wheel' }}"

# 3. User Management: Eric (Interactive User)
- name: Ensure user 'eric' exists
  user:
    name: eric
    shell: /bin/bash
    groups: "{{ admin_group }}"
    append: yes
    password_lock: no

# 4. User Management: Ansible (Automation User)
- name: Ensure user 'ansible' exists
  user:
    name: ansible
    shell: /bin/bash
    groups: "{{ admin_group }}"
    append: yes
    password_lock: yes

# 5. SSH Key Management
- name: Set authorized key for 'ansible' user
  authorized_key:
    user: ansible
    state: present
    key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"

- name: Set authorized key for 'eric' user
  authorized_key:
    user: eric
    state: present
    key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"

# 6. Sudoers Configuration
- name: Remove legacy sudoers file (cleanup)
  file:
    path: /etc/sudoers.d/ansible
    state: absent

- name: Configure passwordless sudo for ansible user
  copy:
    dest: /etc/sudoers.d/z99-ansible
    content: "ansible ALL=(ALL) NOPASSWD: ALL\n"
    owner: root
    group: root
    mode: '0440'
    validate: visudo -cf %s
