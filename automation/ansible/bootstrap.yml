---
- name: Bootstrap Server for Ansible
  hosts: homelab
  become: yes
  vars:
    ansible_user_name: ansible
    # Read public key especially made for Ansible
    ansible_ssh_key: "{{ lookup('file', '~/.ssh/ansible_ed25519.pub') }}"

  tasks:
    - name: Ensure ansible user exists
      ansible.builtin.user:
        name: "{{ ansible_user_name }}"
        comment: "Ansible Automation User"
        shell: /bin/bash
        groups: sudo
        append: yes
        state: present
        create_home: yes

    - name: Set up authorized keys for the ansible user
      ansible.builtin.authorized_key:
        user: "{{ ansible_user_name }}"
        state: present
        key: "{{ ansible_ssh_key }}"

    - name: Allow ansible user to use sudo without password
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/ansible-user"
        content: "{{ ansible_user_name }} ALL=(ALL) NOPASSWD: ALL"
        mode: '0440'
        validate: 'visudo -cf %s' 
