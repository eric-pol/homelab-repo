---
# 1. Directory structure
- name: "Ensure Keycloak docker directory exists"
  ansible.builtin.file:
    path: "{{ project_root }}/docker/keycloak"
    state: directory
    mode: '0755'

# 2. Database storage
- name: "Ensure Database storage on NVMe"
  ansible.builtin.file:
    path: "/mnt/fast/docker/keycloak/db"
    state: directory
    mode: '0700'
    owner: 999
    group: 999
  become: yes

# 3. Docker Compose File
- name: "Deploy Docker Compose Template"
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ project_root }}/docker/keycloak/docker-compose.yml"
    mode: '0640'
  notify: Restart Keycloak

# 4. Systemd Service File (Bronbestand)
- name: "Deploy Systemd Service Template"
  ansible.builtin.template:
    src: keycloak-docker.service.j2
    dest: "{{ project_root }}/system/keycloak-docker.service"
    mode: '0644'

# 5. Linking (DIRECTLY NOW, not via handler)
- name: "Link Systemd Service to /etc/systemd/system"
  ansible.builtin.file:
    src: "{{ project_root }}/system/keycloak-docker.service"
    dest: "/etc/systemd/system/keycloak.service"
    state: link
  become: yes

# 6. Enable and start service
- name: "Ensure Keycloak service is enabled and started"
  ansible.builtin.systemd:
    name: keycloak
    enabled: yes
    state: started
    daemon_reload: yes  # Important: let systemd read the new link
  become: yes


